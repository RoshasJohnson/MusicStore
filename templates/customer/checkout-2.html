{% extends 'customer/header.html' %}
{% load static %}
{% block content %}


<div id="app">
    <!--====== App Content ======-->
    <div class="app-content">


        <!--====== Section 3 ======-->
     <div class="u-s-p-b-60">
        <form Action = "" name="myForm"  id = "form"   method="get">
            <!--====== Section Content ======-->
            <div class="section__content">
                <div class="container">
                    <div class="checkout-f">
                        <div class="row">
                         
                            <div class="col-lg-12">
                                <h1 class="checkout-f__h1">ORDER SUMMARY</h1>

                                <!--====== Order Summary ======-->
                                <div class="o-summary">
                                    <div class="o-summary__section u-s-m-b-30">
                                        <div class="o-summary__item-wrap gl-scroll">
                                        
                                        
                                           
                                           {% for item in Items %}
                                            <div   class="o-card">
                                                <div class="o-card__flex">
                                                    <div class="o-card__img-wrap">

                                                        <img class="u-img-fluid"  src="{{item.product_image.url }}" alt=""></div>
                                                    <div class="o-card__info-wrap">

                                                        <span class="o-card__name mt-3">

                                                            <a id= "product"  data-product="{{item.id}}" href="{% url 'selected_Product' item.id %}">{{item.product_name}}</a></span>

                                                        <span class="o-card__quantity">Quantity x 1</span>

                                                        <span class="o-card__price text-danger"> INR {{item.product_prize}}</span></div>
                                                </div>

                                                <a class="o-card__del far fa-trash-alt"></a>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="o-summary__section u-s-m-b-30">
                                        <div class="o-summary__box">
                                            <h1 class="checkout-f__h1">SHIPPING & BILLING</h1>
                                            <span class="ship-b__text">Ship to: </span>
                                            <div class="row">
                                                {% if form %}
                                                {% for i in form %}
                                                <div class="col-sm-6 mt-2">
                                                    <div class="card">
                                                        <div class="card-body">
                                                            <h5 class="card-title">Address  {{ forloop.counter }}</h5>
                                                            <p class="ship-b__p">{{i.first_name}} {{i.last_name}} 
                                                                <br>{{i.house_name}} , {{i.street_name}} street 
                                                                <br>{{i.city}} {{i.state}}<br> postal-code:{{i.post_code}}
                                                            </p>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input  type="radio" name= "address" value ="{{i.id}}"  class="form-check-input address" id="ad{{forloop.counter}}"/>
                                                            <label  class="form-check-label text-danger" for="address">
                                                              Select Address  
                                                            </label>
                                                          </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            
                                            </div>
                                            {% else %}
                                              <P class = "text-danger ml-2 "> You don't have an address <P>
                                              {% endif %}
                                        </div>
                                    </div><P>
                                    <div class = "col-lg-4 mb-3">
                                        {% for i in Items  %}
                                        
                                        <a type="button" href = "{% url 'new_address' i.id %}" class="btn btn-warning btn-sm">
                                            Add new address
                                        </a>
                                        {% endfor %}
                                        
                                        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                            <div class="modal-dialog">
                                              <div class="modal-content">
                                                <div class="modal-header">
                                                  <h5 class="modal-title" id="exampleModalLabel">New message</h5>
                                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                  <form>
                                                    <div class="mb-3">
                                                      <label for="recipient-name" class="col-form-label">Recipient:</label>
                                                      <input type="text" class="form-control" id="recipient-name">
                                                    </div>
                                                    <div class="mb-3">
                                                      <label for="message-text" class="col-form-label">Message:</label>
                                                      <textarea class="form-control" id="message-text"></textarea>
                                                    </div>
                                                  </form>
                                                </div>
                                                <div class="modal-footer">
                                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                  <button type="button" class="btn btn-primary">Send message</button>
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                    </div>
                                    <div class="o-summary__section u-s-m-b-30">
                                        <div class="o-summary__box">
                                            <table class="o-summary__table">
                                                <tbody>
                                                   
                                                      {% for i in Items %}
                                                        
                                                      <tr>
                                                          <td>TOTAL</td>
                                                          <td>₹ {{i.product_prize }}</td>
                                                        </tr>
                                                        {% endfor %}
                         
                                                    <tr>
                                                        <td>DELIVERY CHARGE</td>
                                                        <td> ₹ 40</td>
                                                    </tr>
                                                    <tr>
                                                        <td>TAX</td>
                                                        <td>₹ {{tax}}</td>
                                                    </tr>
                                                    
                                                 
                                                 
                                                    <tr>
                                                        <td class = "text-danger" >GRAND TOTAL</td>
                                                        
                                                        <td  id = "prize" data-prize="{{grandtotal}}" class = "text-danger"> ₹ {{grandtotal}}</td>
                                                      
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="o-summary__section u-s-m-b-30">
                                        <div class="o-summary__box">
                                            <h1 class="checkout-f__h1">PAYMENT INFORMATION</h1>
                                          
                                                <div class="u-s-m-b-10">

                                                    <!--====== Radio Box ======-->
                                                    <div class="radio-box">

                                                        <input type="radio" id="cash-on-delivery"  onclick="showDiv()" value="cod" name="payment">
                                                        <div class="radio-box__state radio-box__state--primary">

                                                            <label class="radio-box__label" for="cash-on-delivery">Cash on Delivery</label></div>
                                                    </div>
                                                    <!--====== End - Radio Box ======-->

                                                </div>
                                             
                                               
                                               
                                                <div class="u-s-m-b-10">

                                                    <!--====== Radio Box ======-->
                                                    <div class="radio-box">

                                                        <input type="radio" id = "paypalid" value="paypal" onclick="showDiv()" name="payment">
                                                        <div class="radio-box__state radio-box__state--primary ">

                                                            <label class="radio-box__label" for="pay-pal">Pay Pal</label></div>
                                                    </div>
                                                    <!--====== End - Radio Box ======-->
                                                    

                                                </div>
                                                <div class="u-s-m-b-10">

                                                    <!--====== Radio Box ======-->
                                                    <div class="radio-box">

                                                        <input type="radio" id="razopay" value="razopay" name="payment">
                                                        <div class="radio-box__state radio-box__state--primary ">

                                                            <label class="radio-box__label" for="razopay">Razopay</label></div>
                                                    </div>
                                                    <!--====== End - Radio Box ======-->
                                                    

                                                </div>
                                             
                                             

                                                    <div id = "placeorder">
                                                        <input onclick="validateForm()" class="btn btn--e-brand-b-2 bg-danger"  value="PLACE ORDER" type="button"></div>

                                                        <div>
                                                            <div id="myDIV">
                                                        
                                                           
                                                     
                                                        <div id="paypaldiv"  style="display:none;" class="answer_list" >
                                                            <h1 class="checkout-f__h1">Pay with PayPal</h1>
    
                                                        <div id="smart-button-container">
                                                            <div style="text-align: center;">
                                                            <div id="paypal-button-container"></div>
                                                            </div>
                                                        </div>
                                                        </div>
                                        </div>
                                    </div>
                                </div>
                                <!--====== End - Order Summary ======-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--====== End - Section Content ======-->
        </form>
      </div>
        <!--====== End - Section 3 ======-->
    </div>
    <!--====== End - App Content ======-->

    <script src ="https://www.paypal.com/sdk/js?client-id=AXFtIbQiSj8ugYxqBxOyQEXV2pXBoTdlWk10t1nHTf2LAqqapZd3isxVNHGtUIUFKJKjD43ooSxq-dal&currency=USD&disable-funding=credit,card" data-sdk-integration-source="button-factory"></script>
       
                        
    <!--====== Modal Section ======-->
    <!--=========================== script starting ======================================-->
             <script>
                let total= document.getElementById('prize')
                let num =total.getAttribute('data-prize');
                function showDiv() {
                    let payment = document.forms["myForm"]["payment"].value;
                    if(payment == 'paypal'){
                        
                        let address = document.forms["myForm"]["address"].value;
                        if (address == ''){
                            document.getElementById('paypalid').checked =false
                           validateForm()

                        }
                        else{
                    
                        document.getElementById('paypaldiv').style.display = "block";
                        document.getElementById('placeorder').style.display = "none";
                    }
                        
                       

                    } 
                    
                    else if (payment == "cod"){
                    document.getElementById('paypaldiv').style.display = "none";
                    document.getElementById('placeorder').style.display = "block";
                   

                     }
                    
                  
                     }

                     function initPayPalButton() {
                        paypal.Buttons({
                          style: {
                            shape: 'rect',
                            color: 'gold',
                            layout: 'vertical',
                            label: 'paypal',
                            
                          },
                  
                          createOrder: function(data, actions) {
                            return actions.order.create({
                              purchase_units: [{"amount":{"currency_code":"USD","value":num}}]
                            });
                          },
                  
                          onApprove: function (data, actions) {
                            return actions.order.capture().then(function (details) {
                              // Show a success message to the buyer
                              alert('Transaction completed by ' + details.payer.name.given_name + '!');
                      
                              send_data_to_backend()
                              alert("hi" )
                            });
                          },
                      
                  
                          onError: function(err) {
                            console.log(err);
                          }
                        }).render('#paypal-button-container');
                      }
                      initPayPalButton();







            function validateForm() {

                 if ( addressCheck() == true && paymentcheck() == true  ) {
                   let payment = document.forms["myForm"]["payment"].value;  
                    if (payment == 'cod'){
                        let address = document.forms["myForm"]["address"].value;
                        let payment = document.forms["myForm"]["payment"].value; 
                        let product = document.getElementById('product')
                        var productId = product.getAttribute('data-product');
                        console.log(productId,"productid")
                        let total= document.getElementById('prize')
                        let num =total.getAttribute('data-prize');
                        let get_total = parseInt(num)
                        console.log(get_total)
                       console.log( typeof(get_total))

                     
                       
                        console.log('user in logged in ,sending data....')
                        console.log(payment,address)
                    
                        var url = '/order_placing/'
                        fetch(url,{
                        method:'POST',
                        headers:{'content-Type':'application/json',
                        'X-CSRFToken':csrftoken,
                        },
                        body:JSON.stringify({'payment':payment,'address':address,
                        productId:productId,'get_total':get_total})

                        })
                        .then((response)=>{
                            return response.json()
                          })
                          .then((data)=>{
                            console.log('data:',data)
                            
                            Swal.fire({
                                title: 'Order placed successfully ',
                                showClass: {
                                  popup: 'animate__animated animate__fadeInDown'
                                },
                                hideClass: {
                                  popup: 'animate__animated animate__fadeOutUp'
                                },
                                timer: 1500000,
                              })
                              setTimeout(() => {
                                window.location.href = "/manage_account"
                             }, 1000);
                              
                            
                          })
                        

                       
                    }
                 }
                function addressCheck(){
                    let address = document.forms["myForm"]["address"].value;
                    if (address == "") {
                     
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Please select address!',  
                          })
                      return false;
                    }
                    else{
                        return true
                    }
                } 
                
                function paymentcheck(){
                    let payment_method = document.forms["myForm"]["payment"].value;
                    if (payment_method == "") {
                      
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: "You don't selected any payment methods!",  
                          })
                      return false;
                    }
                    else{

                        return true
                    }

                }
             }
   

              function send_data_to_backend(){
                let address = document.forms["myForm"]["address"].value;
                let payment = document.forms["myForm"]["payment"].value; 
                let product = document.getElementById('product')
                var productId = product.getAttribute('data-product');
                console.log(productId,"productid")
                let total= document.getElementById('prize')
                let num =total.getAttribute('data-prize');
                let get_total = parseInt(num)
                console.log(get_total)
               console.log( typeof(get_total))

             
               
                console.log('user in logged in ,sending data....')
                console.log(payment,address)
            
                var url = '/order_placing/'
                fetch(url,{
                method:'POST',
                headers:{'content-Type':'application/json',
                'X-CSRFToken':csrftoken,
                },
                body:JSON.stringify({'payment':payment,'address':address,
                productId:productId,'get_total':get_total})

                })
                .then((response)=>{
                    return response.json()
                  })
                  .then((data)=>{
                    console.log('data:',data)
                    
                    Swal.fire({
                        title: 'Order placed successfully ',
                        showClass: {
                          popup: 'animate__animated animate__fadeInDown'
                        },
                        hideClass: {
                          popup: 'animate__animated animate__fadeOutUp'
                        },
                        timer: 1500000,
                      })
                      setTimeout(() => {
                        window.location.href = "/manage_account"
                     }, 1000);
                      
                    
                  })
              }
            </script>   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.3.10/sweetalert2.js" integrity="sha512-u9p1QPpG9YeeTQeM8Uj/TTGw8/OOLJqDFB3iUNx6HwN54HcsEyT96NCjPVn+m3B5ydE9KP7wD6Kb11n1fCt5QQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.3.10/sweetalert2.min.js" integrity="sha512-LwESE8nE3vcnoUWmYo6skVQ+BRT5UhqnPweGro7e22RSDLVwftCfFIPt+Ha2tm1Gg7RXvYp/jPyih3DUB06PwA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.3.10/sweetalert2.all.js" integrity="sha512-g4BEr9uX8/EsXakUmNF2Geowd5ww8fc9bUaOblLyVJJu2okCYnge1m0pVHbHsusPKV2Dmlm7bu/i6uLisa80sw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.3.10/sweetalert2.all.min.js" integrity="sha512-IG3jJs+NhoPszr+n3I3AHLii1LFFGEVZoorGJFkrd+flS4dgdAVL0AAGiPHlXB0ZD5mgPmcpVKm4KBybCeXLLA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock %}